<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory & Production Management</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet">
    <link href="/css/navbar.css" rel="stylesheet">
    <link href="/css/main.css" rel="stylesheet">
    
    <!-- JavaScript Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/inventory.js"></script>
    <script src="/js/fba-transfers.js"></script>

    <!-- Custom Styles -->
    <style>
        .dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .dialog-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 80%;
            max-height: 80%;
            overflow-y: auto;
        }

        .dialog h2 {
            margin-top: 0;
            color: #333;
        }

        .error-message,
        .dialog-message {
            white-space: pre-wrap;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
        }

        .dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 4px;
            color: white;
            z-index: 1000;
            animation: fadeInOut 3s ease-in-out;
        }

        .toast.success {
            background: #4CAF50;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        .error-message, .confirm-message {
            white-space: pre-wrap;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            margin: 0;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1050;
        }
        .toast.success .toast-header {
            background-color: #28a745;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Alerts container -->
    <div id="alertsContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>
    
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="/index.html">Inventory & Production</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link active" href="/index.html">Inventory</a></li>
                    <!-- Production Dropdown -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="productionDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Production
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="productionDropdown">
                            <li><a class="dropdown-item" href="/production-process.html">Production Process</a></li>
                            <li><a class="dropdown-item" href="/mmr.html">MMR</a></li>
                            <li><a class="dropdown-item" href="/production-history.html">History</a></li>
                        </ul>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="/forecast.html">Forecast</a></li>
                    <!-- Admin Dropdown -->
                    <li class="nav-item dropdown admin-only" style="display: none;">
                        <a class="nav-link dropdown-toggle" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Admin
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="adminDropdown">
                            <li><a class="dropdown-item" href="/admin.html">Admin Overview</a></li>
                            <li><a class="dropdown-item" href="/sku-mapping.html">SKU Mapping</a></li>
                            <li><a class="dropdown-item" href="/amazon-mapping.html">Amazon Mapping</a></li>
                        </ul>
                    </li>
                </ul>
                <div class="ms-auto">
                    <span id="usernameDisplay" class="me-2"></span>
                    <button id="logoutBtn" class="btn btn-outline-danger btn-sm">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row mb-3">
            <div class="col-12">
                <div id="authErrorPanel" class="d-none alert alert-danger">
                    <strong>Authentication Error</strong>
                    <p>There might be issues with your login session. Please try refreshing your authentication.</p>
                    <button class="btn btn-outline-light" onclick="relogin()">Re-login Now</button>
                </div>
            </div>
        </div>
        
        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link tab-link active" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button" role="tab">
                    Inventory Management
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link tab-link" id="production-tab" data-bs-toggle="tab" data-bs-target="#production" type="button" role="tab">
                    Production Orders
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link tab-link" id="fba-transfers-tab" data-bs-toggle="tab" data-bs-target="#fba-transfers" type="button" role="tab">
                    FBA Transfers
                </button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabsContent">
            <!-- Inventory Tab -->
            <div class="tab-pane fade show active" id="inventory" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Inventory Items</h2>
                    <div class="btn-group">
                        <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addItemModal">
                            <i class="bi bi-plus-circle"></i> Add New Item
                        </button>
                        <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#receiveShipmentModal">
                            <i class="bi bi-box-seam"></i> Receive Shipment
                        </button>
                        <button id="sync-fba-button" class="btn btn-info">
                            <i class="bi bi-sync"></i> Sync FBA Inventory
                        </button>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="inventorySearch" placeholder="Search items...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="typeFilter">
                            <option value="">All Types</option>
                            <option value="raw ingredient">Raw Ingredient</option>
                            <option value="finished good">Finished Good</option>
                            <option value="packaging">Packaging</option>
                            <option value="label">Label</option>
                        </select>
                    </div>
                    <div class="col-md-5">
                        <div class="d-flex justify-content-end align-items-center">
                            <div class="me-3">
                                <label for="inventoryPageSizeTop" class="form-label me-2">Items per page:</label>
                                <select id="inventoryPageSizeTop" class="form-select form-select-sm d-inline-block" style="width: auto;">
                                    <option value="50" selected>50</option>
                                    <option value="100">100</option>
                                    <option value="250">250</option>
                                </select>
                            </div>
                            <nav aria-label="Inventory pagination top">
                                <ul class="pagination pagination-sm mb-0" id="inventoryPaginationControlsTop"></ul>
                            </nav>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="inventory-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="sku" style="cursor: pointer">SKU <i class="bi bi-arrow-down"></i></th>
                                <th class="sortable" data-sort="name" style="cursor: pointer">Name <i class="bi bi-arrow-down"></i></th>
                                <th class="sortable" data-sort="type" style="cursor: pointer">Type <i class="bi bi-arrow-down"></i></th>
                                <th class="sortable" data-sort="total_stock" style="cursor: pointer">Warehouse Stock <i class="bi bi-arrow-down"></i></th>
                                <th class="sortable" data-sort="fba_inventory" style="cursor: pointer">FBA Inventory <i class="bi bi-arrow-down"></i></th>
                                <th class="sortable" data-sort="total_available" style="cursor: pointer">Total Available <i class="bi bi-arrow-down"></i></th>
                                <th class="sortable" data-sort="minimum_quantity" style="cursor: pointer">Min. Qty <i class="bi bi-arrow-down"></i></th>
                                <th class="sortable" data-sort="unit_type" style="cursor: pointer">Unit Type <i class="bi bi-arrow-down"></i></th>
                                <th>Batches</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody">
                            <!-- Inventory items will be populated here -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination Controls for Inventory -->
                <div class="d-flex justify-content-between align-items-center mt-3 mb-5">
                    <div>
                        <label for="inventoryPageSize" class="form-label me-2">Items per page:</label>
                        <select id="inventoryPageSize" class="form-select form-select-sm d-inline-block" style="width: auto;">
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                            <option value="250">250</option>
                        </select>
                    </div>
                    <nav aria-label="Inventory pagination">
                        <ul class="pagination mb-0" id="inventoryPaginationControls"></ul>
                    </nav>
                </div>
            </div>

            <!-- Production Tab -->
            <div class="tab-pane fade" id="production" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Production Orders</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addOrderModal">
                        <i class="bi bi-plus-circle"></i> Create Production Order
                    </button>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="id" style="cursor: pointer">Order ID <i class="bi bi-arrow-down"></i></th>
                                <th class="sortable" data-sort="product_sku" style="cursor: pointer">Product SKU <i class="bi bi-arrow-down"></i></th>
                                <th class="sortable" data-sort="quantity" style="cursor: pointer">Quantity <i class="bi bi-arrow-down"></i></th>
                                <th class="sortable" data-sort="status" style="cursor: pointer">Status <i class="bi bi-arrow-down"></i></th>
                                <th class="sortable" data-sort="finished_batch_number" style="cursor: pointer">Batch Number <i class="bi bi-arrow-down"></i></th>
                                <th class="sortable" data-sort="due_date" style="cursor: pointer">Due Date <i class="bi bi-arrow-down"></i></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productionTableBody">
                            <!-- Production orders will be populated here -->
                        </tbody>
                    </table>
                </div>
                <nav aria-label="Production orders pagination">
                    <ul class="pagination" id="paginationControls"></ul>
                </nav>
            </div>
            
            <!-- FBA Transfers Tab -->
            <div class="tab-pane fade" id="fba-transfers" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>FBA Transfers</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTransferModal">
                        <i class="bi bi-box-arrow-right"></i> Create FBA Transfer
                    </button>
                </div>
                
                <!-- Transfer filters and search -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="transferSearch" placeholder="Search transfers...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="transferStatusFilter">
                            <option value="">All Statuses</option>
                            <option value="in_transit">In Transit</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="reconciled">Reconciled</option>
                            <option value="error">Error</option>
                        </select>
                    </div>
                </div>
                
                <!-- Transfers table -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="transfers-table">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Product Name</th>
                                <th>Quantity</th>
                                <th>Transfer Date</th>
                                <th>Status</th>
                                <th>Shipment ID</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transfersTableBody">
                            <!-- Transfers will be populated here -->
                            <tr>
                                <td colspan="7" class="text-center">No FBA transfers found</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination for transfers table -->
                <nav aria-label="Transfers pagination">
                    <ul class="pagination" id="transferPaginationControls"></ul>
                </nav>
            </div>
        </div>

        <!-- FBA Inventory Dashboard (Hidden) -->
        <!--
        <div class="row mt-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Amazon FBA Inventory</h5>
                        <div>
                            <a href="/amazon-mapping.html" class="btn btn-sm btn-outline-primary">View All</a>
                            <button id="refresh-fba" class="btn btn-sm btn-outline-secondary ms-2">
                                <i class="bi bi-arrow-repeat"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card mb-3">
                                    <div class="card-body text-center">
                                        <h6 class="text-muted">Total FBA Products</h6>
                                        <h2 id="fba-total-products">-</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card mb-3">
                                    <div class="card-body text-center">
                                        <h6 class="text-muted">Total FBA Inventory</h6>
                                        <h2 id="fba-total-inventory">-</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card mb-3">
                                    <div class="card-body text-center">
                                        <h6 class="text-muted">Unfulfillable Units</h6>
                                        <h2 id="fba-unfulfillable" class="text-danger">-</h2>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h6>Low Stock Warning <span class="badge bg-warning ms-2">Less than 20 available</span></h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>SKU</th>
                                            <th>Name</th>
                                            <th>Available</th>
                                            <th>Total</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="fba-low-stock">
                                        <tr>
                                            <td colspan="5" class="text-center">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        -->
    </div>

    <!-- Add Item Modal -->
    <div class="modal fade" id="addItemModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Inventory Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addItemForm">
                        <div class="mb-3">
                            <label for="sku" class="form-label">SKU</label>
                            <input type="text" class="form-control" id="sku" required>
                        </div>
                        <div class="mb-3">
                            <label for="name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="type" class="form-label">Type</label>
                            <select class="form-select" id="type" required>
                                <option value="raw ingredient">Raw Ingredient</option>
                                <option value="finished good">Finished Good</option>
                                <option value="packaging">Packaging</option>
                                <option value="label">Label</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="stockLevel" class="form-label">Stock Level</label>
                            <input type="number" class="form-control" id="stockLevel" required>
                        </div>
                        <div class="mb-3">
                            <label for="minimumQuantity" class="form-label">Minimum Quantity</label>
                            <input type="number" class="form-control" id="minimumQuantity" placeholder="Enter minimum stock level...">
                            <small class="text-muted">Threshold for low stock alerts</small>
                        </div>
                        <div class="mb-3">
                            <label for="unitType" class="form-label">Unit Type</label>
                            <select class="form-select" id="unitType" required>
                                <option value="">Select unit type</option>
                                <!-- Weight -->
                                <optgroup label="Weight">
                                    <option value="kg">Kilograms (kg)</option>
                                    <option value="g">Grams (g)</option>
                                    <option value="lb">Pounds (lb)</option>
                                    <option value="oz">Ounces (oz)</option>
                                </optgroup>
                                <!-- Volume -->
                                <optgroup label="Volume">
                                    <option value="L">Liters (L)</option>
                                    <option value="mL">Milliliters (mL)</option>
                                    <option value="gal">Gallons (gal)</option>
                                    <option value="fl oz">Fluid Ounces (fl oz)</option>
                                </optgroup>
                                <!-- Length -->
                                <optgroup label="Length">
                                    <option value="m">Meters (m)</option>
                                    <option value="cm">Centimeters (cm)</option>
                                    <option value="in">Inches (in)</option>
                                    <option value="ft">Feet (ft)</option>
                                </optgroup>
                                <!-- Count -->
                                <optgroup label="Count">
                                    <option value="pcs">Pieces (pcs)</option>
                                    <option value="units">Units</option>
                                    <option value="boxes">Boxes</option>
                                    <option value="cases">Cases</option>
                                    <option value="rolls">Rolls</option>
                                    <option value="sheets">Sheets</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="batchNumber" class="form-label">Batch Number</label>
                            <input type="text" class="form-control" id="batchNumber">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addInventoryItem()">Add Item</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Production Order Modal -->
    <div class="modal fade" id="addOrderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Production Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addOrderForm">
                        <div class="mb-3">
                            <label for="productSku" class="form-label">Product SKU</label>
                            <select class="form-select" id="productSku" required data-live-search="true">
                                <option value="">Select a product</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="quantity" class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="quantity" required min="1">
                        </div>
                        <div class="mb-3">
                            <label for="dueDate" class="form-label">Due Date</label>
                            <input type="date" class="form-control" id="dueDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="mmrVersion" class="form-label">MMR Version</label>
                            <select class="form-select" id="mmrVersion" required disabled>
                                <option value="">Select MMR version</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="createOrderBtn" onclick="handleCreateProductionOrder()">
                        <span id="createOrderSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        Create Order
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Receive Shipment Modal -->
    <div class="modal fade" id="receiveShipmentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Receive Shipment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="receiveShipmentForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="receiptNumber" class="form-label">Receipt/PO Number</label>
                                    <input type="text" class="form-control" id="receiptNumber" required>
                                </div>
                                <div class="mb-3">
                                    <label for="supplier" class="form-label">Supplier</label>
                                    <input type="text" class="form-control" id="supplier" required>
                                </div>
                                <div class="mb-3">
                                    <label for="deliveryDate" class="form-label">Delivery Date</label>
                                    <input type="date" class="form-control" id="deliveryDate" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="receivedBy" class="form-label">Received By</label>
                                    <input type="text" class="form-control" id="receivedBy" required>
                                </div>
                                <div class="mb-3">
                                    <label for="shipmentTemp" class="form-label">Shipment Temperature (Â°C)</label>
                                    <input type="number" step="0.1" class="form-control" id="shipmentTemp">
                                </div>
                                <div class="mb-3">
                                    <label for="qualityStatus" class="form-label">Quality Check Status</label>
                                    <select class="form-select" id="qualityStatus" required>
                                        <option value="">Select status</option>
                                        <option value="passed">Passed</option>
                                        <option value="pending">Pending Inspection</option>
                                        <option value="failed">Failed</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Items Received</label>
                            <div id="receivedItems">
                                <div class="received-item card mb-3">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">Item SKU</label>
                                                    <select class="form-select item-sku" required style="width: 100%">
                                                        <option value="">Select item</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Batch Number</label>
                                                    <input type="text" class="form-control item-batch" required>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">Quantity Received</label>
                                                    <input type="number" class="form-control item-quantity" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Expiration Date</label>
                                                    <input type="date" class="form-control item-expiration">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Notes</label>
                                            <textarea class="form-control item-notes" rows="2"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addReceivedItemField()">
                                <i class="bi bi-plus"></i> Add Another Item
                            </button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="receiveShipment()">Receive Shipment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Transfer Modal -->
    <div class="modal fade" id="addTransferModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create FBA Transfer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addTransferForm">
                        <div class="mb-3">
                            <label for="transferSku" class="form-label">Product SKU</label>
                            <select class="form-select" id="transferSku" required>
                                <option value="">Select a product</option>
                                <!-- Will be populated with SKUs that have Amazon mappings -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="transferQuantity" class="form-label">Quantity to Transfer</label>
                            <input type="number" class="form-control" id="transferQuantity" required min="1">
                            <div class="form-text">
                                Available warehouse stock: <span id="availableStock">-</span>
                            </div>
                            <div class="form-text">
                                Amazon SKU mapping: <span id="amazonSkuMapping">-</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="shipmentId" class="form-label">Amazon Shipment ID</label>
                            <input type="text" class="form-control" id="shipmentId">
                        </div>
                        <div class="mb-3">
                            <label for="trackingNumber" class="form-label">Tracking Number</label>
                            <input type="text" class="form-control" id="trackingNumber">
                        </div>
                        <div class="mb-3">
                            <label for="transferNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="transferNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="createTransferBtn">
                        <span id="createTransferSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        Create Transfer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
// Global variables for inventory filtering and sorting
let inventorySort = { field: 'sku', direction: 'asc' };
    let inventorySearchTerm = '';
    let inventoryTypeFilter = '';
    
    // Add global variables for inventory pagination
    let inventoryCurrentPage = 1;
    let inventoryPageSize = 50; // Default page size
    
    // Global variables for production orders sorting and pagination
    let currentSort = { field: 'id', direction: 'desc' };
    let currentPage = 1;
    const itemsPerPage = 10;

    document.addEventListener('DOMContentLoaded', async function() {
        console.log('DOM Content Loaded');
        
        // Verify authentication early
        const token = localStorage.getItem('token');
        if (!token) {
            console.error('No token found on page load');
            document.getElementById('authErrorPanel').classList.remove('d-none');
            return;
        }
        
        try {
            // Check token expiration
            const payload = JSON.parse(atob(token.split('.')[1]));
            if (payload.exp * 1000 < Date.now()) {
                console.error('Token expired on page load');
                document.getElementById('authErrorPanel').classList.remove('d-none');
                return;
            }
            
            // Check user info
            const user = getCurrentUser();
            console.log('Current user on page load:', user);
            if (!user) {
                console.error('No user data found on page load');
                document.getElementById('authErrorPanel').classList.remove('d-none');
                return;
            }
        } catch (error) {
            console.error('Error checking authentication on page load:', error);
            document.getElementById('authErrorPanel').classList.remove('d-none');
            return;
        }
        
        // Add event listeners for inventory search and filter
        const inventorySearch = document.getElementById('inventorySearch');
        const typeFilter = document.getElementById('typeFilter');
        
        if (inventorySearch) {
            inventorySearch.addEventListener('input', (e) => {
                inventorySearchTerm = e.target.value.toLowerCase();
                inventoryCurrentPage = 1; // Reset page on new search
                loadInventoryItems();
            });
        }

        if (typeFilter) {
            typeFilter.addEventListener('change', (e) => {
                inventoryTypeFilter = e.target.value.toLowerCase();
                inventoryCurrentPage = 1; // Reset page on filter change
                loadInventoryItems();
            });
        }

        // Add event listeners for inventory sorting
        document.querySelectorAll('#inventory th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const field = th.dataset.sort;
                if (inventorySort.field === field) {
                    inventorySort.direction = inventorySort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    inventorySort.field = field;
                    inventorySort.direction = 'asc';
                }
                updateInventorySortIcons();
                inventoryCurrentPage = 1; // Reset page on sort change
                loadInventoryItems();
            });
        });

        // Add event listener for inventory page size change
        const inventoryPageSizeSelect = document.getElementById('inventoryPageSize');
        if (inventoryPageSizeSelect) {
            inventoryPageSizeSelect.addEventListener('change', (e) => {
                inventoryPageSize = parseInt(e.target.value);
                inventoryCurrentPage = 1; // Reset to first page when size changes
                loadInventoryItems();
            });
        }

        // Add event listener for top inventory page size change
        const inventoryPageSizeTopSelect = document.getElementById('inventoryPageSizeTop');
        if (inventoryPageSizeTopSelect) {
            inventoryPageSizeTopSelect.addEventListener('change', (e) => {
                inventoryPageSize = parseInt(e.target.value);
                document.getElementById('inventoryPageSize').value = e.target.value; // Keep bottom select in sync
                inventoryCurrentPage = 1; // Reset to first page when size changes
                loadInventoryItems();
            });
        }

        // Add event listeners for production sorting
        document.querySelectorAll('#production th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const field = th.dataset.sort;
                if (currentSort.field === field) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.field = field;
                    currentSort.direction = 'asc';
                }
                updateProductionSortIcons();
                loadProductionOrders(currentPage);
            });
        });

        // Load initial data
        await loadInventoryItems();
        await loadProductionOrders(currentPage);
        await initializeProductSKUDropdown();

        // Initialize the Create Production Order modal
        const addOrderModal = document.getElementById('addOrderModal');
        addOrderModal.addEventListener('show.bs.modal', function (event) {
            console.log('Create Production Order modal is being shown');
            document.getElementById('addOrderForm').reset();
            $('#productSku').val(null).trigger('change');
        });

        $('#productSku').select2({
            theme: 'bootstrap-5',
            width: '100%',
            placeholder: 'Search for a product...',
            allowClear: true,
            dropdownParent: $('#addOrderModal')
        });

        // Check if user is admin to show admin nav item
        if (user && user.role === 'admin') {
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = 'block';
            });
        }
    });

    // Display user info
    const user = getCurrentUser();
    if (user) {
        document.getElementById('usernameDisplay').textContent = user.username;
    }

    // Load inventory items with pagination, filtering, and sorting
    async function loadInventoryItems(page = inventoryCurrentPage, limit = inventoryPageSize, sortBy = inventorySort.field, sortDir = inventorySort.direction) {
        console.log(`loadInventoryItems called with: page=${page}, limit=${limit}, sortBy=${sortBy}, sortDir=${sortDir}`);
        inventoryCurrentPage = page;
        inventoryPageSize = limit;
        inventorySort.field = sortBy;
        inventorySort.direction = sortDir;

        const search = document.getElementById('inventorySearch').value.toLowerCase();
        const type = document.getElementById('typeFilter').value.toLowerCase();
        const fbaFilterElement = document.getElementById('fbaFilter');
        const hasFba = fbaFilterElement ? fbaFilterElement.checked : false;

        let url = `/api/inventory?page=${page}&limit=${limit}&sortBy=${sortBy}&sortDir=${sortDir}`;
        if (search) url += `&search=${encodeURIComponent(search)}`;
        if (type) url += `&type=${encodeURIComponent(type)}`;
        if (hasFba) url += `&hasAmazonFba=true`;

        try {
            // Use authenticatedFetch instead of makeAuthenticatedRequest
            const response = await authenticatedFetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            console.log('Raw response data from /api/inventory:', data);

            // Create pagination data if it doesn't exist in the response
            let items = [];
            let paginationData = {};
            
            if (Array.isArray(data)) {
                // Server returned items directly as array
                items = data;
                // Create pagination data manually
                paginationData = {
                    currentPage: page,
                    totalPages: Math.ceil(items.length / limit),
                    totalItems: items.length
                };
            } else if (data.items) {
                // Server returned { items: [...], pagination: {...} } format
                items = data.items;
                paginationData = data.pagination || {};
            } else {
                // Fallback if data structure is unexpected
                items = data;
                paginationData = {
                    currentPage: page,
                    totalPages: 1,
                    totalItems: items.length
                };
            }
            
            console.log('Extracted items:', items);
            console.log('Pagination data:', paginationData);

            const tableBody = document.getElementById('inventoryTableBody');
            tableBody.innerHTML = ''; // Clear previous items

            if (!items || items.length === 0) {
                console.log('No items found or items array is empty.');
                tableBody.innerHTML = '<tr><td colspan="12" class="text-center">No inventory items found.</td></tr>';
                renderInventoryPagination({}); // Clear pagination if no items
                return;
            }

            items.forEach(item => {
                const tr = document.createElement('tr');
                const isLowStock = item.minimum_quantity && item.total_stock < item.minimum_quantity;
                if (isLowStock) {
                    tr.classList.add('table-warning');
                }
                
                tr.innerHTML = `
                    <td>${item.sku}</td>
                    <td>${item.name}</td>
                    <td>${item.type}</td>
                    <td>${isLowStock ? `<span class="text-danger">${item.total_stock}</span>` : item.total_stock}</td>
                    <td>${item.fba_inventory || '-'}</td>
                    <td>${item.total_available || '-'}</td>
                    <td>${item.minimum_quantity || '-'}</td>
                    <td>${item.unit_type || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary batch-toggle-btn" onclick="toggleBatches(this, '${item.sku}')">
                            <i class="bi bi-chevron-down me-1"></i> Show ${item.batches && item.batches.length ? item.batches.length : 0} Batches
                        </button>
                    </td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-outline-primary" onclick="editItem('${item.sku}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="archiveItem('${item.sku}')">
                            <i class="bi bi-archive"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(tr);

                // Add batches row (unchanged, assuming backend still provides batches for current page items)
                const batchesRow = document.createElement('tr');
                batchesRow.className = 'batches-row d-none';
                batchesRow.dataset.sku = item.sku;
                batchesRow.innerHTML = `
                    <td colspan="8">
                        <div class="batches-container p-3 bg-light">
                            <h6 class="mb-2">Batch Details for ${item.sku} - ${item.name}</h6>
                            <table class="table table-sm table-bordered mb-0">
                                <thead>
                                    <tr>
                                        <th>Batch Number</th>
                                        <th>Stock Level</th>
                                        <th>Receipt/PO</th>
                                        <th>Supplier</th>
                                        <th>Received Date</th>
                                        <th>Expiration</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${item.batches && item.batches.length ? 
                                      item.batches.map(batch => `
                                        <tr>
                                            <td>${batch.batch_number || '-'}</td>
                                            <td>${batch.stock_level} ${item.unit_type || ''}</td>
                                            <td>${batch.receipt_number || '-'}</td>
                                            <td>${batch.supplier || '-'}</td>
                                            <td>${batch.delivery_date ? new Date(batch.delivery_date).toLocaleDateString() : '-'}</td>
                                            <td>${batch.expiration_date ? new Date(batch.expiration_date).toLocaleDateString() : '-'}</td>
                                            <td>${batch.notes || '-'}</td>
                                        </tr>
                                    `).join('') : 
                                    '<tr><td colspan="7" class="text-center">No batches available</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </td>
                `;
                tableBody.appendChild(batchesRow);
            });

            // Update and render pagination controls
            const totalItems = items.length > limit ? items.length : (paginationData.totalItems || items.length);
            const totalPages = paginationData.totalPages || Math.ceil(totalItems / limit);
            
            const pagination = {
                currentPage: page,
                totalPages: totalPages,
                totalItems: totalItems,
                limit: limit
            };
            
            console.log('Using pagination:', pagination);
            renderInventoryPagination(pagination);

        } catch (error) {
            console.error('Error loading inventory items:', error);
            const tableBody = document.getElementById('inventoryTableBody');
            tableBody.innerHTML = '<tr><td colspan="12" class="text-center text-danger">Error loading inventory items.</td></tr>';
            renderInventoryPagination({}); // Clear pagination on error
        }
    }
    
    // New function to render inventory pagination controls
    function renderInventoryPagination(pagination) {
        // Render bottom pagination
        renderPaginationControls('inventoryPaginationControls', pagination);
        
        // Render top pagination (smaller size)
        renderPaginationControls('inventoryPaginationControlsTop', pagination, true);
        
        // Keep the page size selectors in sync
        const bottomPageSize = document.getElementById('inventoryPageSize');
        const topPageSize = document.getElementById('inventoryPageSizeTop');
        if (bottomPageSize && topPageSize) {
            bottomPageSize.value = inventoryPageSize.toString();
            topPageSize.value = inventoryPageSize.toString();
        }
    }
    
    // Reusable function to render pagination controls
    function renderPaginationControls(elementId, pagination, isCompact = false) {
        const paginationControls = document.getElementById(elementId);
        if (!paginationControls || !pagination || pagination.totalPages <= 1) {
            if (paginationControls) paginationControls.innerHTML = ''; // Clear if exists but not needed
            return;
        }
        paginationControls.innerHTML = ''; // Clear previous controls

        const { currentPage, totalPages } = pagination;

        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" aria-label="Previous"><span aria-hidden="true">Â«</span></a>`;
        if (currentPage > 1) {
            prevLi.addEventListener('click', (e) => {
                e.preventDefault();
                loadInventoryItems(currentPage - 1);
            });
        }
        paginationControls.appendChild(prevLi);

        // Page numbers (simplified logic for brevity)
        // Show current page, +/- 2 pages, first and last page
        const pagesToShow = [];
        
        // For compact view (top pagination), show fewer page numbers
        const pagesToDisplay = isCompact ? 3 : 5;
        
        if (totalPages <= pagesToDisplay) {
            for (let i = 1; i <= totalPages; i++) pagesToShow.push(i);
        } else {
            pagesToShow.push(1);
            if (currentPage > (isCompact ? 2 : 3)) pagesToShow.push('...');
            
            const start = Math.max(2, currentPage - (isCompact ? 0 : 1));
            const end = Math.min(totalPages - 1, currentPage + (isCompact ? 0 : 1));
            
            for (let i = start; i <= end; i++) {
                pagesToShow.push(i);
            }
            
            if (currentPage < totalPages - (isCompact ? 1 : 2)) pagesToShow.push('...');
            pagesToShow.push(totalPages);
        }
        
        pagesToShow.forEach(pageNum => {
             const pageLi = document.createElement('li');
             if (pageNum === '...') {
                 pageLi.className = 'page-item disabled';
                 pageLi.innerHTML = `<span class="page-link">...</span>`;
             } else {
                 pageLi.className = `page-item ${pageNum === currentPage ? 'active' : ''}`;
                 pageLi.innerHTML = `<a class="page-link" href="#">${pageNum}</a>`;
                 if (pageNum !== currentPage) {
                     pageLi.addEventListener('click', (e) => {
                         e.preventDefault();
                         loadInventoryItems(pageNum);
                     });
                 }
             }
             paginationControls.appendChild(pageLi);
         });

        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" aria-label="Next"><span aria-hidden="true">Â»</span></a>`;
        if (currentPage < totalPages) {
            nextLi.addEventListener('click', (e) => {
                e.preventDefault();
                loadInventoryItems(currentPage + 1);
            });
        }
        paginationControls.appendChild(nextLi);
    }

    function updateInventorySortIcons() {
        document.querySelectorAll('#inventory th.sortable').forEach(th => {
            const field = th.dataset.sort;
            const icon = th.querySelector('i.bi');
            if (icon) {
                if (field === inventorySort.field) {
                    icon.className = `bi bi-arrow-${inventorySort.direction === 'asc' ? 'up' : 'down'}`;
                } else {
                    icon.className = 'bi bi-arrow-down';
                }
            }
        });
    }

    // Load production orders with pagination
    async function loadProductionOrders(page) {
        try {
            console.log(`Fetching production orders from API for page ${page}...`);
            const sortBy = currentSort.field;
            const sortDir = currentSort.direction;
            const response = await authenticatedFetch(`/api/v1/production-orders?page=${page}&limit=${itemsPerPage}&sort_by=${sortBy}&sort_dir=${sortDir}`);
            
            if (!response.ok) {
                throw new Error(`Failed to fetch production orders: ${response.status}`);
            }
            
            const data = await response.json();
            const orders = data.orders || [];
            const pagination = data.pagination || {
                currentPage: page,
                totalPages: 1,
                limit: itemsPerPage,
                totalItems: orders.length
            };

            console.log('Production orders received:', orders);

            const tbody = document.getElementById('productionTableBody');
            if (!tbody) {
                console.error('Production table body element not found');
                return;
            }
            
            tbody.innerHTML = '';
            
            if (orders.length === 0) {
                console.log('No production orders found');
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No production orders found</td></tr>';
            } else {
                console.log(`Rendering ${orders.length} orders...`);
                orders.forEach(order => {
                    const tr = document.createElement('tr');
                    tr.dataset.orderId = order.id;
                    
                    let dueDateFormatted = 'Not set';
                    if (order.due_date) {
                        try {
                            const dueDate = new Date(order.due_date);
                            if (!isNaN(dueDate.getTime())) {
                                dueDateFormatted = dueDate.toLocaleDateString();
                                const isOverdue = order.status !== 'Completed' && dueDate < new Date();
                                if (isOverdue) {
                                    tr.classList.add('table-danger');
                                }
                            }
                        } catch (e) {
                            console.error('Error formatting due date:', e);
                        }
                    }
                    
                    tr.innerHTML = `
                        <td>${order.id}</td>
                        <td>${order.product_sku}</td>
                        <td>${order.quantity}</td>
                        <td><span class="badge bg-${getStatusColor(order.status)}">${order.status}</span></td>
                        <td>${order.finished_batch_number || '-'}</td>
                        <td>${dueDateFormatted}</td>
                        <td class="action-buttons">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewOrder(${order.id})">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="updateOrderStatus(${order.id})">
                                <i class="bi bi-arrow-repeat"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            updateProductionSortIcons();
            renderPagination(pagination);
        } catch (error) {
            console.error('Error loading production orders:', error);
            showAlert('danger', 'Failed to load production orders: ' + error.message);
        }
    }

    function updateProductionSortIcons() {
        document.querySelectorAll('#production th.sortable').forEach(th => {
            const field = th.dataset.sort;
            const icon = th.querySelector('i.bi');
            if (icon) {
                if (field === currentSort.field) {
                    icon.className = `bi bi-arrow-${currentSort.direction === 'asc' ? 'up' : 'down'}`;
                } else {
                    icon.className = 'bi bi-arrow-down';
                }
            }
        });
    }

    function renderPagination(pagination) {
        const paginationControls = document.getElementById('paginationControls');
        if (!paginationControls) {
            console.error('Pagination controls element not found');
            return;
        }
        paginationControls.innerHTML = '';

        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${pagination.currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" aria-label="Previous"><span aria-hidden="true">Â«</span></a>`;
        prevLi.addEventListener('click', (e) => {
            e.preventDefault();
            if (pagination.currentPage > 1) {
                currentPage = pagination.currentPage - 1;
                loadProductionOrders(currentPage);
            }
        });
        paginationControls.appendChild(prevLi);

        // Page numbers
        const maxPagesToShow = 5;
        let startPage = Math.max(1, pagination.currentPage - Math.floor(maxPagesToShow / 2));
        let endPage = Math.min(pagination.totalPages, startPage + maxPagesToShow - 1);
        if (endPage - startPage + 1 < maxPagesToShow) {
            startPage = Math.max(1, endPage - maxPagesToShow + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            const pageLi = document.createElement('li');
            pageLi.className = `page-item ${i === pagination.currentPage ? 'active' : ''}`;
            pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            pageLi.addEventListener('click', (e) => {
                e.preventDefault();
                currentPage = i;
                loadProductionOrders(currentPage);
            });
            paginationControls.appendChild(pageLi);
        }

        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${pagination.currentPage === pagination.totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" aria-label="Next"><span aria-hidden="true">Â»</span></a>`;
        nextLi.addEventListener('click', (e) => {
            e.preventDefault();
            if (pagination.currentPage < pagination.totalPages) {
                currentPage = pagination.currentPage + 1;
                loadProductionOrders(currentPage);
            }
        });
        paginationControls.appendChild(nextLi);
    }

        // Initialize product SKU dropdown
        async function initializeProductSKUDropdown() {
            try {
                console.log('Initializing product SKU dropdown...');
                // Use the exact type name, case-insensitive match handled by backend
                const response = await authenticatedFetch('/api/inventory?type=Finished Good&limit=500');
                if (!response) {
                    console.error('No response from inventory API');
                    return;
                }
                
                const data = await response.json();
                console.log('Received data from inventory API:', data);
                
                // Handle the new response format with items array
                const products = data.items || [];
                console.log(`Loaded ${products.length} finished goods:`, products);
                
                // Specifically log if Maitake product is found
                const maitakeProducts = products.filter(p => 
                    p.name.toLowerCase().includes('maitake') || 
                    p.sku === 'FG-2001'
                );
                console.log(`Found ${maitakeProducts.length} Maitake products:`, maitakeProducts);
                
                const productSelect = document.getElementById('productSku');
                
                // Clear existing options
                productSelect.innerHTML = '<option value="">Select a product</option>';
                
                // Add new options sorted by name for easier finding
                products.sort((a, b) => a.name.localeCompare(b.name)).forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.sku;
                    option.textContent = `${product.name} (${product.sku})`;
                    productSelect.appendChild(option);
                    
                    // Log if we're adding the Maitake product
                    if (product.sku === 'FG-2001') {
                        console.log('Added Maitake Mushroom Capsules to dropdown');
                    }
                });

                // Check the raw HTML of the dropdown to verify elements were added
                console.log('Dropdown HTML after adding options:', productSelect.innerHTML);
                
                // Count options in dropdown
                console.log(`Dropdown has ${productSelect.options.length} options (should be ${products.length + 1} with placeholder)`);
                
                // Check if the FG-2001 option actually exists in the DOM
                const maitakeOption = Array.from(productSelect.options).find(option => option.value === 'FG-2001');
                console.log('Maitake option in DOM:', maitakeOption ? 'Yes' : 'No');
                
                if (maitakeOption) {
                    console.log('Maitake option text:', maitakeOption.textContent);
                }

                // Initialize Select2 with debugging
                $(productSelect).on('select2:open', function(e) {
                    console.log('Select2 dropdown opened');
                    
                    // Count visible options in Select2 dropdown
                    setTimeout(() => {
                        const visibleOptions = document.querySelectorAll('.select2-results__option');
                        console.log(`Visible options in Select2 dropdown: ${visibleOptions.length}`);
                        
                        // Check if Maitake is in the visible options
                        const hasMaitake = Array.from(visibleOptions).some(el => 
                            el.textContent.toLowerCase().includes('maitake') || 
                            el.textContent.includes('FG-2001')
                        );
                        console.log('Maitake visible in Select2 dropdown:', hasMaitake ? 'Yes' : 'No');
                    }, 500); // Wait for Select2 to populate dropdown
                });
                
                $(productSelect).select2({
                    theme: 'bootstrap-5',
                    width: '100%',
                    placeholder: 'Search for a product...',
                    allowClear: true,
                    dropdownParent: $('#addOrderModal')
                });

                // Add a dedicated search for maitake button for testing
                const maitakeSearchBtn = document.createElement('button');
                maitakeSearchBtn.textContent = 'Test Search for Maitake';
                maitakeSearchBtn.className = 'btn btn-sm btn-outline-info mt-2';
                maitakeSearchBtn.style.float = 'right';
                maitakeSearchBtn.onclick = function(e) {
                    e.preventDefault();
                    // Try to find maitake in the select2 dropdown
                    $('#productSku').select2('open');
                    $('.select2-search__field').val('maitake');
                    $('.select2-search__field').trigger('input');
                    
                    setTimeout(() => {
                        const visibleResults = document.querySelectorAll('.select2-results__option');
                        console.log('Search results for "maitake":', Array.from(visibleResults).map(el => el.textContent));
                    }, 500);
                };
                document.querySelector('#addOrderForm .mb-3:first-child').appendChild(maitakeSearchBtn);

                // Add change event listener to Select2
                $(productSelect).on('select2:select', async function(e) {
                    console.log('Select2 change event triggered');
                    
                    const productSku = e.params.data.id;
                    const mmrVersionSelect = document.getElementById('mmrVersion');
                    
                    mmrVersionSelect.innerHTML = '<option value="">Loading MMR versions...</option>';
                    mmrVersionSelect.disabled = true;
                    
                    console.log('Product SKU changed to:', productSku);
                    
                    if (!productSku) {
                        mmrVersionSelect.innerHTML = '<option value="">Please select a product first</option>';
                        return;
                    }
                    
                    try {
                        // Use the versions endpoint
                        console.log('Fetching MMR versions for SKU:', productSku);
                        const token = localStorage.getItem('token');
                        
                        const response = await fetch(`/api/mmr/${encodeURIComponent(productSku)}/versions`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        console.log('Response status:', response.status);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const versions = await response.json();
                        console.log('Received versions:', versions);
                        
                        if (versions && Array.isArray(versions) && versions.length > 0) {
                            mmrVersionSelect.innerHTML = '<option value="">Select MMR Version</option>';
                            
                            versions.forEach(version => {
                                const option = document.createElement('option');
                                option.value = version.version;
                                const date = version.created_at ? new Date(version.created_at).toLocaleDateString() : 'N/A';
                                option.textContent = `Version ${version.version} (${date})`;
                                mmrVersionSelect.appendChild(option);
                            });
                            
                            mmrVersionSelect.disabled = false;
                        } else {
                            mmrVersionSelect.innerHTML = '<option value="">No MMR versions available</option>';
                            alert('No MMR versions found for this product. Please create an MMR first.');
                        }
                    } catch (error) {
                        console.error('Error loading MMR versions:', error);
                        mmrVersionSelect.innerHTML = '<option value="">Error loading MMR versions</option>';
                        mmrVersionSelect.disabled = true;
                    }
                });

                // Also handle clearing the selection
                $(productSelect).on('select2:clear', function() {
                    console.log('Selection cleared');
                    const mmrVersionSelect = document.getElementById('mmrVersion');
                    mmrVersionSelect.innerHTML = '<option value="">Select MMR version</option>';
                    mmrVersionSelect.disabled = true;
                });
            } catch (error) {
                console.error('Error initializing product SKU dropdown:', error);
            }
        }

        // Add inventory item
        async function addInventoryItem() {
            const form = document.getElementById('addItemForm');
            const formData = {
                sku: document.getElementById('sku').value,
                name: document.getElementById('name').value,
                type: document.getElementById('type').value,
                stock_level: parseInt(document.getElementById('stockLevel').value),
                minimum_quantity: document.getElementById('minimumQuantity').value ? 
                    parseFloat(document.getElementById('minimumQuantity').value) : null,
                unit_type: document.getElementById('unitType').value,
                batch_number: document.getElementById('batchNumber').value
            };

            try {
                const response = await authenticatedFetch('/api/inventory', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response) {
                    throw new Error('Failed to add inventory item');
                }

                const modal = bootstrap.Modal.getInstance(document.getElementById('addItemModal'));
                modal.hide();
                form.reset();
                loadInventoryItems();
            } catch (error) {
                console.error('Error adding inventory item:', error);
                alert('Failed to add inventory item');
            }
        }

        async function createProductionOrder(mmr_product_sku, mmr_version, quantity, force = false) {
            try {
                const response = await authenticatedFetch('/api/production-orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        mmr_product_sku,
                        mmr_version,
                        quantity,
                        force
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    if (response.status === 409 && data.code === 'INSUFFICIENT_INVENTORY') {
                        // Show warning dialog with option to force create
                        const warnings = data.details.warnings.map(w => 
                            `${w.name} (${w.sku}): need ${w.required} ${w.unit}, have ${w.available} ${w.unit}`
                        ).join('\n');
                        
                        const proceed = await showConfirmDialog(
                            'Insufficient Inventory',
                            `The following items have insufficient inventory:\n\n${warnings}\n\nDo you want to proceed anyway?`,
                            'Proceed',
                            'Cancel'
                        );

                        if (proceed) {
                            // Retry with force=true
                            return createProductionOrder(mmr_product_sku, mmr_version, quantity, true);
                        } else {
                            throw new Error('Production order cancelled due to insufficient inventory');
                        }
                    } else {
                        // Show error dialog for other errors
                        let errorMessage = data.message;
                        if (data.details) {
                            if (Array.isArray(data.details)) {
                                errorMessage += '\n\nDetails:\n' + data.details.map(d => d.message || JSON.stringify(d)).join('\n');
                            } else if (typeof data.details === 'object') {
                                errorMessage += '\n\nDetails:\n' + Object.entries(data.details)
                                    .map(([key, value]) => `${key}: ${JSON.stringify(value)}`)
                                    .join('\n');
                            }
                        }
                        await showErrorDialog('Error Creating Production Order', errorMessage);
                        throw new Error(data.message);
                    }
                }

                // Success case
                showSuccessMessage('Production order created successfully!');
                return data;
            } catch (error) {
                console.error('Error creating production order:', error);
                throw error;
            }
        }

        // Success message function
        function showSuccessMessage(message) {
            const toast = document.createElement('div');
            toast.className = 'toast success';
            toast.innerHTML = `
                <div class="toast-header">
                    <strong class="me-auto">Success</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            `;
            document.body.appendChild(toast);
            
            // Initialize Bootstrap toast
            const bsToast = new bootstrap.Toast(toast, {
                autohide: true,
                delay: 3000
            });
            bsToast.show();
            
            // Remove from DOM after hiding
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        // Error dialog function
        async function showErrorDialog(title, message) {
            return new Promise((resolve) => {
                const modalId = 'errorModal' + Date.now();
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.id = modalId;
                modal.setAttribute('tabindex', '-1');
                modal.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title">${title}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <pre class="error-message">${message}</pre>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                const bsModal = new bootstrap.Modal(modal);
                bsModal.show();
                
                // Resolve when modal is hidden
                modal.addEventListener('hidden.bs.modal', () => {
                    modal.remove();
                    resolve();
                });
            });
        }

        // Confirmation dialog function
        async function showConfirmDialog(title, message, confirmText = 'OK', cancelText = 'Cancel') {
            return new Promise((resolve) => {
                const modalId = 'confirmModal' + Date.now();
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.id = modalId;
                modal.setAttribute('tabindex', '-1');
                modal.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-warning">
                                <h5 class="modal-title">${title}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <pre class="confirm-message">${message}</pre>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${cancelText}</button>
                                <button type="button" class="btn btn-primary confirm-btn">${confirmText}</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                const bsModal = new bootstrap.Modal(modal);
                
                // Set up confirm button
                const confirmBtn = modal.querySelector('.confirm-btn');
                confirmBtn.addEventListener('click', () => {
                    bsModal.hide();
                    resolve(true);
                });
                
                // Handle dismiss/cancel
                modal.addEventListener('hidden.bs.modal', () => {
                    if (!modal.resolved) {
                        resolve(false);
                    }
                    modal.remove();
                });
                
                bsModal.show();
            });
        }

        // Helper function to get status color
        function getStatusColor(status) {
            switch (status.toLowerCase()) {
                case 'pending':
                    return 'warning';
                case 'in progress':
                    return 'info';
                case 'completed':
                    return 'success';
                case 'cancelled':
                    return 'danger';
                default:
                    return 'secondary';
            }
        }

        // Edit inventory item
        async function editItem(sku) {
            console.log('Edit item called for SKU:', sku);
            try {
                const response = await authenticatedFetch(`/api/inventory/${sku}`);
                const item = await response.json();
                console.log('Fetched item data:', item);
                
                // Populate form with item data
                document.getElementById('sku').value = item.sku;
                document.getElementById('name').value = item.name;
                document.getElementById('type').value = item.type;
                document.getElementById('stockLevel').value = item.stock_level;
                document.getElementById('minimumQuantity').value = item.minimum_quantity || '';
                document.getElementById('unitType').value = item.unit_type || '';
                document.getElementById('batchNumber').value = item.batch_number || '';
                
                console.log('Form populated with:', {
                    sku: item.sku,
                    name: item.name,
                    type: item.type,
                    stock_level: item.stock_level,
                    minimum_quantity: item.minimum_quantity || '',
                    unit_type: item.unit_type || '',
                    batch_number: item.batch_number || ''
                });
                
                // Update the modal title
                document.querySelector('#addItemModal .modal-title').textContent = 'Edit Inventory Item';
                
                // Update the submit button text
                const submitButton = document.querySelector('#addItemModal .modal-footer .btn-primary');
                submitButton.textContent = 'Update Item';
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('addItemModal'));
                modal.show();
                
                // Update form submission
                const form = document.getElementById('addItemForm');
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    await updateInventoryItem(sku);
                };
                
                // Also update the button click handler
                submitButton.onclick = () => updateInventoryItem(sku);
                
                console.log('Form submission handler updated for editing');
            } catch (error) {
                console.error('Error loading item details:', error);
                alert('Failed to load item details');
            }
        }

        // Update inventory item
        async function updateInventoryItem(sku) {
            console.log('Update inventory item called for SKU:', sku);
            const formData = {
                name: document.getElementById('name').value,
                type: document.getElementById('type').value,
                stock_level: parseInt(document.getElementById('stockLevel').value),
                minimum_quantity: document.getElementById('minimumQuantity').value ? 
                    parseFloat(document.getElementById('minimumQuantity').value) : null,
                unit_type: document.getElementById('unitType').value,
                batch_number: document.getElementById('batchNumber').value
            };

            console.log('Form data for update:', formData);

            try {
                console.log('Sending PUT request to:', `/api/inventory/${sku}`);
                const response = await authenticatedFetch(`/api/inventory/${sku}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response) {
                    throw new Error('Failed to update inventory item');
                }

                const result = await response.json();
                console.log('Update response:', result);

                const modal = bootstrap.Modal.getInstance(document.getElementById('addItemModal'));
                modal.hide();
                
                // Reset form and button handlers
                const form = document.getElementById('addItemForm');
                form.reset();
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    await addInventoryItem();
                };
                
                // Reset button text and handler
                const submitButton = document.querySelector('#addItemModal .modal-footer .btn-primary');
                submitButton.textContent = 'Add Item';
                submitButton.onclick = () => addInventoryItem();
                
                // Reset modal title
                document.querySelector('#addItemModal .modal-title').textContent = 'Add New Inventory Item';
                
                console.log('Form reset and UI updated after successful edit');
                loadInventoryItems();
            } catch (error) {
                console.error('Error updating inventory item:', error);
                alert('Failed to update inventory item: ' + error.message);
            }
        }

        // Archive inventory item (previously deleteItem)
        async function archiveItem(sku) {
            if (!checkAuthForAction('delete_inventory')) { // Still uses delete_inventory permission
                return;
            }
            if (!confirm('Are you sure you want to archive this item? It will be hidden from most views but can be reactivated later.')) {
                return;
            }

            try {
                const response = await authenticatedFetch(`/api/inventory/${sku}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: false }) // Set is_active to false
                });

                if (!response || !response.ok) {
                    const errorData = await response?.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Failed to archive inventory item');
                }

                showAlert('Item archived successfully', 'success');
                loadInventoryItems(); // Refresh the list to hide the item
            } catch (error) {
                console.error('Error archiving inventory item:', error);
                showAlert('Failed to archive inventory item: ' + error.message, 'danger');
            }
        }

        // View production order
        async function viewOrder(id) {
            try {
                const response = await authenticatedFetch(`/api/v1/production-orders/${id}`);
                const order = await response.json();
                
                // Calculate scaling factor
                const scalingFactor = order.quantity / order.mmr_base_quantity;
                
                // Create a modal to display the order details
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.id = 'orderDetailsModal';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Production Order Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <h6>Order Information</h6>
                                        <p><strong>Product SKU:</strong> ${order.product_sku}</p>
                                        <p><strong>Batch Number:</strong> ${order.finished_batch_number}</p>
                                        <p><strong>Status:</strong> ${order.status}</p>
                                        <p><strong>Due Date:</strong> ${new Date(order.due_date).toLocaleDateString()}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>MMR Details</h6>
                                        <p><strong>Version:</strong> ${order.mmr_version}</p>
                                        <p><strong>Base Quantity:</strong> ${order.mmr_base_quantity}</p>
                                        <p><strong>Scaling Factor:</strong> ${scalingFactor.toFixed(2)}x</p>
                                    </div>
                                </div>
                                
                                <h6>Ingredients</h6>
                                <div class="table-responsive mb-3">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Ingredient</th>
                                                <th>Recipe Amount</th>
                                                <th>Inventory Amount</th>
                                                <th>SKU</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${order.batches_used.filter(batch => batch.item_type === 'raw_ingredient').map(ing => `
                                                <tr>
                                                    <td>${ing.item_name}</td>
                                                    <td>${(ing.quantity_used / ing.conversion_factor).toFixed(2)} ${ing.original_unit}</td>
                                                    <td>${ing.quantity_used.toFixed(2)} ${ing.inventory_unit}</td>
                                                    <td>${ing.item_sku}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <h6>Equipment</h6>
                                <ul class="list-group mb-3">
                                    ${order.mmr_equipment.map(eq => `<li class="list-group-item">${eq}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                const modalInstance = new bootstrap.Modal(modal);
                modalInstance.show();
                
                modal.addEventListener('hidden.bs.modal', function() {
                    document.body.removeChild(modal);
                });
            } catch (error) {
                console.error('Error viewing order:', error);
                alert('Failed to load order details');
            }
        }

        // Update production order status
        async function updateOrderStatus(id) {
            const statuses = ['Pending', 'In Progress', 'Completed', 'Cancelled'];
            const currentStatus = document.querySelector(`tr[data-order-id="${id}"] .badge`).textContent;
            const currentIndex = statuses.indexOf(currentStatus);
            const nextStatus = statuses[(currentIndex + 1) % statuses.length];

            try {
                const response = await authenticatedFetch(`/api/v1/production-orders/${id}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: nextStatus })
                });

                if (!response) {
                    throw new Error('Failed to update order status');
                }

                loadProductionOrders();
            } catch (error) {
                console.error('Error updating order status:', error);
                alert('Failed to update order status');
            }
        }

        // Populate SKU dropdowns in receive shipment modal
        document.getElementById('receiveShipmentModal').addEventListener('show.bs.modal', async () => {
            try {
                // Get all inventory items first
                const response = await authenticatedFetch('/api/inventory');
                const data = await response.json();
                const items = data || [];
                
                // Initialize Select2 for all SKU dropdowns
                $('.item-sku').each(function() {
                    $(this).select2({
                        theme: 'bootstrap-5',
                        width: '100%',
                        placeholder: 'Search for an item...',
                        allowClear: true,
                        dropdownParent: $('#receiveShipmentModal'),
                        data: items.map(item => ({
                            id: item.sku,
                            text: `${item.name} (${item.sku})`,
                            item: item
                        }))
                    });
                });
            } catch (error) {
                console.error('Error initializing SKU dropdowns:', error);
            }
        });

        // Initialize Select2 for new SKU dropdowns when adding items
        function addReceivedItemField() {
            const template = document.querySelector('.received-item').cloneNode(true);
            template.querySelector('.item-sku').value = '';
            template.querySelector('.item-batch').value = '';
            template.querySelector('.item-quantity').value = '';
            template.querySelector('.item-expiration').value = '';
            template.querySelector('.item-notes').value = '';
            
            // Add remove button for additional items
            const removeBtn = document.createElement('button');
            removeBtn.className = 'btn btn-outline-danger btn-sm position-absolute top-0 end-0 m-2';
            removeBtn.innerHTML = '<i class="bi bi-trash"></i>';
            removeBtn.onclick = function() {
                this.closest('.received-item').remove();
            };
            template.querySelector('.card-body').appendChild(removeBtn);
            
            document.getElementById('receivedItems').appendChild(template);

            // Initialize Select2 for the new SKU dropdown
            const newSelect = template.querySelector('.item-sku');
            $(newSelect).select2({
                theme: 'bootstrap-5',
                width: '100%',
                placeholder: 'Search for an item...',
                allowClear: true,
                dropdownParent: $('#receiveShipmentModal'),
                data: Array.from($('.item-sku').first().find('option')).map(opt => ({
                    id: opt.value,
                    text: opt.text,
                    item: opt.dataset.item
                }))
            });
        }

        // Receive shipment
        async function receiveShipment() {
            const form = document.getElementById('receiveShipmentForm');
            const items = Array.from(document.querySelectorAll('.received-item')).map(item => ({
                sku: item.querySelector('.item-sku').value,
                batch_number: item.querySelector('.item-batch').value,
                quantity: parseInt(item.querySelector('.item-quantity').value),
                expiration_date: item.querySelector('.item-expiration').value || null,
                notes: item.querySelector('.item-notes').value || null
            }));

            const formData = {
                receipt_number: document.getElementById('receiptNumber').value,
                supplier: document.getElementById('supplier').value,
                delivery_date: document.getElementById('deliveryDate').value,
                received_by: document.getElementById('receivedBy').value,
                shipment_temperature: document.getElementById('shipmentTemp').value || null,
                quality_status: document.getElementById('qualityStatus').value,
                items: items
            };

            try {
                const response = await authenticatedFetch('/api/inventory/receive', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response) {
                    throw new Error('Failed to receive shipment');
                }

                const modal = bootstrap.Modal.getInstance(document.getElementById('receiveShipmentModal'));
                modal.hide();
                form.reset();
                loadInventoryItems();
            } catch (error) {
                console.error('Error receiving shipment:', error);
                alert('Failed to receive shipment');
            }
        }

        // Function to toggle the visibility of batch details
        function toggleBatches(button, sku) {
            const batchesRow = document.querySelector(`.batches-row[data-sku="${sku}"]`);
            const icon = button.querySelector('i');
            
            if (batchesRow.classList.contains('d-none')) {
                // Show batches
                batchesRow.classList.remove('d-none');
                icon.classList.remove('bi-chevron-down');
                icon.classList.add('bi-chevron-up');
                button.innerHTML = button.innerHTML.replace('Show', 'Hide');
            } else {
                // Hide batches
                batchesRow.classList.add('d-none');
                icon.classList.remove('bi-chevron-up');
                icon.classList.add('bi-chevron-down');
                button.innerHTML = button.innerHTML.replace('Hide', 'Show');
            }
        }

        // Utility function to show alerts
        function showAlert(type, message) {
            const alertsContainer = document.getElementById('alertsContainer');
            if (!alertsContainer) {
                console.error('Alerts container not found');
                alert(message);
                return;
            }
            
            const alertId = 'alert-' + Date.now();
            const alertHtml = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            alertsContainer.innerHTML += alertHtml;
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                const alertElement = document.getElementById(alertId);
                if (alertElement) {
                    const bsAlert = new bootstrap.Alert(alertElement);
                    bsAlert.close();
                }
            }, 5000);
        }

        // Check auth permissions for critical actions
        function checkAuthForAction(requiredPermission = null) {
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('No authentication token found');
                showAlert('danger', 'You are not logged in. Please log in to continue.');
                setTimeout(() => {
                    localStorage.clear();
                    window.location.href = '/login.html';
                }, 2000);
                return false;
            }
            
            // Check token expiration
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const isExpired = payload.exp * 1000 < Date.now();
                if (isExpired) {
                    console.error('Token has expired');
                    showAlert('danger', 'Your session has expired. Please log in again.');
                    setTimeout(() => {
                        localStorage.clear();
                        window.location.href = '/login.html';
                    }, 2000);
                    return false;
                }
            } catch (error) {
                console.error('Error checking token:', error);
                showAlert('danger', 'Authentication error. Please log in again.');
                setTimeout(() => {
                    localStorage.clear();
                    window.location.href = '/login.html';
                }, 2000);
                return false;
            }
            
            // Check role permissions
            if (requiredPermission) {
                const user = JSON.parse(localStorage.getItem('user'));
                if (!user) {
                    console.error('No user data found');
                    showAlert('danger', 'User data not found. Please log in again.');
                    setTimeout(() => {
                        localStorage.clear();
                        window.location.href = '/login.html';
                    }, 2000);
                    return false;
                }
                
                const isAdmin = user.role === 'admin';
                const isManager = user.role === 'manager';
                
                if (requiredPermission === 'create_production_order' && !(isAdmin || isManager)) {
                    console.error('Insufficient permissions:', user.role);
                    showAlert('danger', 'You do not have permission to create production orders.');
                    return false;
                }
            }
            
            return true;
        }

        function relogin() {
            console.log('Forcing re-login');
            localStorage.clear();
            window.location.href = '/login.html';
        }

        // FBA Dashboard functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize FBA dashboard
            loadFbaDashboard();
            
            // Refresh button
            const refreshButton = document.getElementById('refresh-fba');
            if (refreshButton) {
                refreshButton.addEventListener('click', function() {
                    this.disabled = true;
                    this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Refreshing...';
                    
                    // Trigger FBA sync with authenticatedFetch
                    authenticatedFetch('/api/v1/sync/fba-inventory')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            loadFbaDashboard();
                            this.disabled = false;
                            this.innerHTML = '<i class="bi bi-arrow-repeat"></i> Refresh';
                        })
                        .catch(error => {
                            console.error('Error syncing FBA inventory:', error);
                            this.disabled = false;
                            this.innerHTML = '<i class="bi bi-arrow-repeat"></i> Refresh';
                        });
                });
            }
            
            // Add event listener for FBA sync button in main inventory view
            const syncFbaButton = document.getElementById('sync-fba-button');
            if (syncFbaButton) {
                syncFbaButton.addEventListener('click', function() {
                    this.disabled = true;
                    this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Syncing FBA...';
                    
                    // Trigger FBA sync with authenticatedFetch
                    authenticatedFetch('/api/v1/sync/fba-inventory')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            loadInventoryItems(); // Reload inventory to show updated FBA data
                            this.disabled = false;
                            this.innerHTML = '<i class="bi bi-sync"></i> Sync FBA Inventory';
                            showAlert('success', 'FBA inventory synced successfully');
                        })
                        .catch(error => {
                            console.error('Error syncing FBA inventory:', error);
                            this.disabled = false;
                            this.innerHTML = '<i class="bi bi-sync"></i> Sync FBA Inventory';
                            showAlert('danger', 'Failed to sync FBA inventory: ' + error.message);
                        });
                });
            }
        });
        
        async function loadFbaDashboard() {
            try {
                // Fetch all inventory with FBA inventory - use authenticated fetch
                const response = await authenticatedFetch('/api/inventory?hasAmazonFba=true');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                const items = data.items || [];
                
                if (Array.isArray(items)) {
                    // Calculate totals
                    let totalProducts = 0;
                    let totalInventory = 0;
                    let totalUnfulfillable = 0;
                    const lowStockItems = [];
                    
                    items.forEach(item => {
                        if (item.fba_inventory > 0) {
                            totalProducts++;
                            totalInventory += item.fba_inventory;
                            
                            if (item.fba_unfulfillable) {
                                totalUnfulfillable += item.fba_unfulfillable;
                            }
                            
                            // Check if low stock
                            if (item.fba_available <= 20) {
                                lowStockItems.push(item);
                            }
                        }
                    });
                    
                    // Update summary cards
                    document.getElementById('fba-total-products').textContent = totalProducts;
                    document.getElementById('fba-total-inventory').textContent = totalInventory;
                    document.getElementById('fba-unfulfillable').textContent = totalUnfulfillable;
                    
                    // Update low stock table
                    const lowStockTable = document.getElementById('fba-low-stock');
                    if (lowStockItems.length > 0) {
                        // Sort by available inventory (ascending)
                        lowStockItems.sort((a, b) => (a.fba_available || 0) - (b.fba_available || 0));
                        
                        let html = '';
                        lowStockItems.forEach(item => {
                            // Determine status indicator
                            let statusClass = 'bg-warning';
                            let statusText = 'Low';
                            if (item.fba_available <= 5) {
                                statusClass = 'bg-danger';
                                statusText = 'Critical';
                            }
                            
                            html += `
                                 <tr>
                                     <td>${item.sku}</td>
                                     <td>${item.name}</td>
                                     <td>${item.fba_available || 0}</td>
                                     <td>${item.fba_inventory || 0}</td>
                                     <td><span class="badge ${statusClass}">${statusText}</span></td>
                                 </tr>
                             `;
                         });
                         lowStockTable.innerHTML = html;
                     } else {
                         lowStockTable.innerHTML = '<tr><td colspan="5" class="text-center">No low stock items found</td></tr>';
                     }
                 } else {
                     console.error('Error loading FBA inventory data');
                 }
             } catch (error) {
                 console.error('Error loading FBA dashboard:', error);
             }
         }
     </script>

    <!-- Function to handle the form submission for creating a production order -->
    <script>
    async function handleCreateProductionOrder() {
        try {
            // Get form values
            const mmr_product_sku = document.getElementById('productSku').value;
            const mmr_version = parseInt(document.getElementById('mmrVersion').value);
            const quantity = parseInt(document.getElementById('quantity').value);

            if (!mmr_product_sku || isNaN(mmr_version) || isNaN(quantity)) {
                await showErrorDialog('Missing Fields', 'Please fill in all required fields: Product SKU, MMR Version, and Quantity.');
                return;
            }

            console.log('Creating production order with:', { mmr_product_sku, mmr_version, quantity });

            // Show spinner
            document.getElementById('createOrderBtn').disabled = true;
            document.getElementById('createOrderSpinner').classList.remove('d-none');

            try {
                const response = await authenticatedFetch('/api/production-orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        mmr_product_sku,
                        mmr_version,
                        quantity,
                        force: false // Start without forcing
                    })
                });

                // Log the response status and headers for debugging
                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);
                
                // Get response data
                const data = await response.json();
                console.log('Response data:', data);
                
                if (!response.ok) {
                    // Handle 409 Conflict specifically for insufficient inventory
                    if (response.status === 409) {
                        console.log('Received 409 Conflict response:', data);
                        
                        // Check if this is an inventory warning
                        if (data.code === 'INSUFFICIENT_INVENTORY' && data.details && data.details.warnings) {
                            // Format warnings for display
                            const warnings = data.details.warnings.map(w => 
                                `${w.name} (${w.sku || 'unknown'}): need ${w.required} ${w.unit}, have ${w.available} ${w.unit}`
                            ).join('\n');
                            
                            // Show confirmation dialog for inventory warnings
                            const proceed = await showConfirmDialog(
                                'Insufficient Inventory',
                                `The following items have insufficient inventory:\n\n${warnings}\n\nDo you want to proceed anyway?`,
                                'Proceed',
                                'Cancel'
                            );

                            if (proceed) {
                                // Try again with force=true
                                console.log('User chose to proceed despite inventory warnings');
                                const forceResponse = await authenticatedFetch('/api/production-orders', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        mmr_product_sku,
                                        mmr_version,
                                        quantity,
                                        force: true
                                    })
                                });

                                const forceData = await forceResponse.json();
                                console.log('Force create response:', forceData);
                                
                                if (!forceResponse.ok) {
                                    throw new Error(forceData.message || 'Failed to create production order');
                                }
                                
                                // Show success message
                                showSuccessMessage('Production order created successfully!');
                                
                                // Close modal
                                const modal = bootstrap.Modal.getInstance(document.getElementById('addOrderModal'));
                                modal.hide();
                                
                                // Refresh production orders list
                                await loadProductionOrders(currentPage);
                                return;
                            } else {
                                console.log('User cancelled production order due to inventory warnings');
                                throw new Error('Production order cancelled due to insufficient inventory');
                            }
                        } else {
                            // Generic 409 error (might be a different conflict)
                            const errorMessage = data.message || 'Conflict error occurred';
                            await showErrorDialog('Conflict Error', errorMessage);
                            throw new Error(errorMessage);
                        }
                    } else {
                        // Handle other error types
                        let errorMessage = data.message || 'An error occurred';
                        if (data.details) {
                            if (Array.isArray(data.details)) {
                                errorMessage += '\n\nDetails:\n' + data.details.map(d => d.message || JSON.stringify(d)).join('\n');
                            } else if (typeof data.details === 'object') {
                                errorMessage += '\n\nDetails:\n' + Object.entries(data.details)
                                    .map(([key, value]) => `${key}: ${JSON.stringify(value)}`)
                                    .join('\n');
                            }
                        }
                        await showErrorDialog('Error Creating Production Order', errorMessage);
                        throw new Error(data.message || 'Failed to create production order');
                    }
                }

                // Show success message
                showSuccessMessage('Production order created successfully!');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('addOrderModal'));
                modal.hide();
                
                // Refresh production orders list
                await loadProductionOrders(currentPage);
            } catch (error) {
                console.error('Error in API call:', error);
                throw error;
            }
        } catch (error) {
            console.error('Error in handleCreateProductionOrder:', error);
        } finally {
            // Hide spinner
            document.getElementById('createOrderBtn').disabled = false;
            document.getElementById('createOrderSpinner').classList.add('d-none');
        }
    }
    </script>
 </body>
 </html>